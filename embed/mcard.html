<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">  
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>PGSA Membership Card</title>
        <link type="text/css" rel="stylesheet" href="/css/wx-card.css"> 
        <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.2/dist/FileSaver.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jdenticon@3.1.0/dist/jdenticon.min.js">
</script>

    </head>
    <body style="background: none transparent">
        <div class="container mcard">
            <div class="mcard-heading">
                <h2>HKU-PGSA 港大研會</h2>
                <div class="spinner"></div>
            </div>
            <div style="margin: auto; padding: 0;" class="mcard-body" >
                <div class="canvas-wrapper">
                    <canvas width="500"  height="350"></canvas>
                </div>
            </div>
            <div class="mcard-foot">
                <button class="btn" id="save-card">Save</button>
                
            </div>
            

        </div>
       
        <script src="/js/pgsa-apps.min.js"></script>
        <script>
            var _pg = _pg || {};
            _pg.sec = 'm'; _pg.ver = 'v1.1.0';
            _pg.refresh = false; // true; //
            _pg.purge = true;
            _pg.init &&  (_pg.ready = _pg.init()) &&  (_pg.enc['dummy'] = 'secret');


            _pg.card_styles = {
                'default': {
                    background: {
                        name: "Default",
                        path: '/css/card-default.jpg',
                        width: 1518, height: 957,
                        // other dimensions

                    },
                    pos: {
                        name: {
                            align: 'center',
                            x: 770, y: 916
                        },
                        uno: {
                            align: 'right',
                            x: 415, y: 900
                        },
                        since_year: {
                            align: 'right',
                            x: 1460, y: 900
                        },
                        qr: {
                            x: 1460-256, y: 400,
                            border: 'white'
                        },
                        avatar: {
                            x: 40, y: 240,
                            border: null
                        }

                    },
                    font: {
                        color: 'black',
                        family: 'Halter',
                        path: '/css/card-HALTER.ttf'
                    },
                    badge: {

                    }
                }
            }
            _pg.default_card_style = function(background_path, background_name){
                let obj = JSON.parse(JSON.stringify(_pg.card_styles['default']));
                obj.background.path = background_path;
                obj.background.name = background_name;
                return obj;
            }
            _pg.card_styles['since21'] = _pg.default_card_style('/css/card-since21.jpg', "New for 2021");
            _pg.card_styles['donate21_special'] = _pg.default_card_style('/css/card-donate21.jpg', "Henan Donation Special");
            _pg.card_styles.donate21_special.pos.avatar.y = 30;
            _pg.card_styles.donate21_special.pos.avatar.x = 30;
            
            

            var params = getQueryFromURL(location.href, decodeURIComponent);
            _pg.heading = 'heading' in params ? params['heading']: 'PGSA Membership Card';
            
            const heading = document.querySelector('.mcard h2');
            heading.innerHTML = _pg.heading;
            let {surname, given_name, uno, since_year, style, qr, unverified, colorDark, avatar, check_uno, no_save, cors_token} = params;
            var canvas = document.querySelector('.mcard-body canvas');

            
            if(_pg.ready && !!style){
                

                if(!!qr){
                    let qr_wrapper = document.createElement('div');
                    _pg.qr_obj = new QRCode(qr_wrapper, {text: qr, colorDark: colorDark || '#000000'});
                    _pg.qr = qr_wrapper.querySelector('canvas');
                    // QR code image data on qr_canvas
                }
                

                let btn_save = document.getElementById('save-card');
                if(no_save){
                    btn_save.remove();
                }else{
                    btn_save.addEventListener('click', ()=>{
                        _pg.saveCard(canvas, uno);
                    })
                };

                let style_opts = style.split(',');
                style = style_opts[0];
                let s = _pg.card_styles[style];
                _pg.log('using style ', style, s);

                
                
                _pg.loaded_fonts = _pg.loaded_fonts || {};
                function drawMCard(s, mark_uno){
                    let _uno = String(uno);
                    if(!!mark_uno){
                        _uno = _uno.substr(0,5)+'XXXX'+_uno.substr(-1);
                    }
                    if(_pg.loaded_fonts[s.font.family]){
                        return _pg.drawMCard(canvas, s, {surname, given_name, uno:_uno, since_year, unverified}, {qr:_pg.qr, avatar: _pg.avatar});
                    }
                    let css = document.createElement('style');
                    css.innerHTML = `
                    @font-face {
                        font-family: '${s.font.family}';
                        src: url('${s.font.path}');
                        font-style: normal;
                    }`;
                    document.head.appendChild(css);
                    // make sure fonts are loaded
                    document.fonts.load('30pt '+s.font.family).then(
                        ()=> {
                            _pg.loaded_fonts[s.font.family] = true;
                            return _pg.drawMCard(canvas, s, {surname, given_name, uno:_uno, since_year, unverified}, {qr:_pg.qr, avatar: _pg.avatar});
                        }
                    );
                }
                let mcard_foot = document.querySelector(".mcard-foot");
                let checker = null; 
                let sel = null;
                if(typeof check_uno != 'undefined'){
                    let L = document.createElement('label');
                    L.innerHTML = '<input type="checkbox">Hide Number';
                    mcard_foot.append(L);
                    checker = mcard_foot.querySelector('input[type="checkbox"]');
                    if(check_uno == "true"){
                        checker.checked = true;
                    }
                }
                

                if(style_opts.length>1){
                    let L = document.createElement('label');
                    //sel = document.createElement("select");
                    L.innerHTML = `Background <select><option value="${style}" selected>${s.background.name}</option>` +
                      style_opts.slice(1).map((k)=>{
                          let s = _pg.card_styles[k];
                          return `<option value="${k}">${s.background.name}</option>`;
                      }).join('') +'</select>';
                    
                    mcard_foot.prepend(L);
                    sel = mcard_foot.querySelector('select');
                    
                }
                sel && sel.addEventListener('change', (e)=>{
                        return drawMCard(_pg.card_styles[sel.value], checker && checker.checked);
                    });
                checker && checker.addEventListener('change', (e)=>{
                    let s = sel? _pg.card_styles[sel.value]: style;
                    drawMCard(s, checker.checked);
                    
                });

                function drawAvatar(){
                    return new Promise((resolve)=>{

                        if(!avatar){
                            return resolve(null);
                        }

                        const avatar_size = 256;
                        let avatar_canvas = _pg.avatar = document.createElement('canvas');
                        avatar_canvas.width = avatar_canvas.height = avatar_size;
                        let ctx = avatar_canvas.getContext("2d");
                        // check if image url
                        if(cors_token && avatar.startsWith('http')){
                            let avatar_url = avatar + 
                            (avatar.split('?').length>1?"":"?") +
                            "cors_token=" + cors_token + "&op_time=" + Date.now();// prevent cache
                            // draw_image
                            const abg = new Image();
                            function draw_avatar(){
                                let asize = abg.width<abg.height? abg.width: abg.height;
                                let sx = (abg.width - asize) / 2 >> 0;
                                let sy = (abg.height - asize) / 2 >> 0;
                                ctx.drawImage(abg, sx, sy, asize, asize, 0, 0, avatar_size, avatar_size);
                            }
                            
                            abg.onload = ()=>{
                                draw_avatar();
                                resolve(_pg.avatar);
                            }
                            if(!no_save){// required if need to export
                                abg.crossOrigin = "Anonymous";
                            }
                            
                            abg.src = avatar_url;
                            return;
                        }
                        
                        if(!!jdenticon){
                            jdenticon.drawIcon(ctx, avatar, avatar_size);
                            return resolve(_pg.avatar);   
                        }  
                        
                        return resolve(null);   

                    });
                }

                
                drawAvatar().then(()=>{
                    drawMCard(s, checker && checker.checked);
                }).catch((err)=>{
                    console.log('failed to load avatar.', err);
                    drawMCard(s, checker && checker.checked);
                });
                

                
                
                
            }
            


        </script>
    </body>
</html>
